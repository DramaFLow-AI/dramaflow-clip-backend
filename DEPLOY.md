# éƒ¨ç½²æŒ‡å—

æœ¬é¡¹ç›®æ”¯æŒä¸‰ç§ç¯å¢ƒçš„ç‹¬ç«‹æ‰“åŒ…å’Œéƒ¨ç½²ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

```bash
# 1. ä¸Šä¼ æ‰“åŒ…å¥½çš„ dist ç›®å½•åˆ°æœåŠ¡å™¨

# 2. å®‰è£…ä¾èµ–
cd /app
pnpm install --prod

# 3. ä¿®å¤è„šæœ¬æ¢è¡Œç¬¦ï¼ˆé‡è¦ï¼ï¼‰
# æ–¹å¼ 1ï¼šä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰
bash fix-scripts.sh

# æ–¹å¼ 2ï¼šæ‰‹åŠ¨ä¿®å¤
sed -i 's/\r$//' start.sh
chmod +x start.sh

# 4. å¯åŠ¨ï¼ˆä¸‰é€‰ä¸€ï¼‰
./start.sh staging                                    # æ–¹å¼ 1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
NODE_ENV=staging node src/main.js                    # æ–¹å¼ 2ï¼šç›´æ¥å¯åŠ¨
pm2 start ecosystem.config.js --only gemini-staging # æ–¹å¼ 3ï¼šä½¿ç”¨ PM2

# æŸ¥çœ‹æ—¥å¿—
pm2 logs  # å¦‚æœä½¿ç”¨ PM2
```

---

## ğŸ“¦ ç¯å¢ƒè¯´æ˜

| ç¯å¢ƒ | é…ç½®æ–‡ä»¶ | ç”¨é€” | æ•°æ®åº“/Redis |
|------|---------|------|-------------|
| **dev** | `.env.dev` | æœ¬åœ°å¼€å‘ç¯å¢ƒ | è¿œç¨‹æµ‹è¯•æœåŠ¡å™¨ |
| **staging** | `.env.staging` | æµ‹è¯•æœåŠ¡å™¨ | è¿œç¨‹æµ‹è¯•æœåŠ¡å™¨ |
| **prod** | `.env.prod` | æ­£å¼ç”Ÿäº§æœåŠ¡å™¨ | æœ¬åœ°æˆ–ç”Ÿäº§æ•°æ®åº“ |

## ğŸš€ æ‰“åŒ…å‘½ä»¤

### 1. æ‰“åŒ…æµ‹è¯•æœåŠ¡å™¨ç‰ˆæœ¬
```bash
pnpm run build:staging
```
**æ‰“åŒ…å†…å®¹ï¼š**
- ç¼–è¯‘åçš„ä»£ç 
- `package.json`
- `.env.staging`ï¼ˆæµ‹è¯•æœåŠ¡å™¨é…ç½®ï¼‰
- `sa.json`ï¼ˆGCP æœåŠ¡è´¦å·ï¼‰
- `prisma/schema.prisma`

**é€‚ç”¨åœºæ™¯ï¼š** éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨

---

### 2. æ‰“åŒ…æ­£å¼æœåŠ¡å™¨ç‰ˆæœ¬
```bash
pnpm run build:prod
```
**æ‰“åŒ…å†…å®¹ï¼š**
- ç¼–è¯‘åçš„ä»£ç 
- `package.json`
- `.env.prod`ï¼ˆæ­£å¼æœåŠ¡å™¨é…ç½®ï¼‰
- `sa.json`ï¼ˆGCP æœåŠ¡è´¦å·ï¼‰
- `prisma/schema.prisma`

**é€‚ç”¨åœºæ™¯ï¼š** éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨

---

### 3. æ‰“åŒ…æ‰€æœ‰ç¯å¢ƒï¼ˆå¼€å‘ç”¨ï¼‰
```bash
pnpm run build
```
**æ‰“åŒ…å†…å®¹ï¼š** åŒ…å«æ‰€æœ‰ `.env` æ–‡ä»¶

**é€‚ç”¨åœºæ™¯ï¼š** å¼€å‘è°ƒè¯•ï¼Œä¸å»ºè®®ç”¨äºå®é™…éƒ¨ç½²

## ğŸ“‚ æ‰“åŒ…åçš„ç›®å½•ç»“æ„

```
dist/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main.js             # å…¥å£æ–‡ä»¶
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma
â”œâ”€â”€ package.json
â”œâ”€â”€ ecosystem.config.js     # PM2 é…ç½®æ–‡ä»¶
â”œâ”€â”€ start.sh                # Linux å¯åŠ¨è„šæœ¬
â”œâ”€â”€ fix-scripts.sh          # è„šæœ¬ä¿®å¤å·¥å…·
â”œâ”€â”€ .env.staging            # æµ‹è¯•ç¯å¢ƒé…ç½®ï¼ˆbuild:stagingï¼‰
â”œâ”€â”€ .env.prod               # ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆbuild:prodï¼‰
â””â”€â”€ sa.json                 # GCP æœåŠ¡è´¦å·
```

## ğŸ–¥ï¸ éƒ¨ç½²åˆ°æœåŠ¡å™¨

### æ­¥éª¤ 1ï¼šæ‰“åŒ…
```bash
# æµ‹è¯•æœåŠ¡å™¨
pnpm run build:staging

# æˆ–æ­£å¼æœåŠ¡å™¨
pnpm run build:prod
```

### æ­¥éª¤ 2ï¼šä¸Šä¼ 
å°† `dist/` ç›®å½•ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š
```bash
# ç¤ºä¾‹ï¼šä½¿ç”¨ scp
scp -r dist/* user@server:/app/

# æˆ–ä½¿ç”¨ rsync
rsync -avz dist/ user@server:/app/
```

### æ­¥éª¤ 3ï¼šå®‰è£…ä¾èµ–
ç™»å½•æœåŠ¡å™¨ï¼š
```bash
cd /app
pnpm install --prod
```

### æ­¥éª¤ 4ï¼šå¯åŠ¨åº”ç”¨

**âš ï¸ é‡è¦ï¼š** æœåŠ¡å™¨ç¯å¢ƒæ¨èç›´æ¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¸è¦ä½¿ç”¨ `pnpm start:staging` æˆ– `pnpm start:prod`ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ä¾èµ–é—®é¢˜ã€‚

**æµ‹è¯•æœåŠ¡å™¨ï¼ˆLinuxï¼‰ï¼š**
```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæœ€ç®€å•ï¼Œæ¨èï¼‰
# é¦–æ¬¡ä½¿ç”¨éœ€è¦è½¬æ¢æ¢è¡Œç¬¦å¹¶æ·»åŠ æ‰§è¡Œæƒé™
sed -i 's/\r$//' start.sh  # è½¬æ¢ Windows æ¢è¡Œç¬¦ä¸º Linux æ ¼å¼
chmod +x start.sh          # æ·»åŠ æ‰§è¡Œæƒé™
./start.sh staging

# æ–¹å¼ 2ï¼šä½¿ç”¨ export
export NODE_ENV=staging
node src/main.js

# æ–¹å¼ 3ï¼šç›´æ¥åœ¨å‘½ä»¤å‰è®¾ç½®
NODE_ENV=staging node src/main.js
```

**æ­£å¼æœåŠ¡å™¨ï¼ˆLinuxï¼‰ï¼š**
```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæœ€ç®€å•ï¼Œæ¨èï¼‰
# é¦–æ¬¡ä½¿ç”¨éœ€è¦è½¬æ¢æ¢è¡Œç¬¦å¹¶æ·»åŠ æ‰§è¡Œæƒé™
sed -i 's/\r$//' start.sh  # è½¬æ¢ Windows æ¢è¡Œç¬¦ä¸º Linux æ ¼å¼
chmod +x start.sh          # æ·»åŠ æ‰§è¡Œæƒé™
./start.sh prod

# æ–¹å¼ 2ï¼šä½¿ç”¨ export
export NODE_ENV=prod
node src/main.js

# æ–¹å¼ 3ï¼šç›´æ¥åœ¨å‘½ä»¤å‰è®¾ç½®
NODE_ENV=prod node src/main.js
```

**Windows æœ¬åœ°æµ‹è¯•ï¼š**
```bash
# ä½¿ç”¨ package.json ä¸­çš„è„šæœ¬ï¼ˆå·²é›†æˆ cross-envï¼‰
pnpm run start:staging
pnpm run start:prod
```

### æ­¥éª¤ 5ï¼šä½¿ç”¨ PM2 å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ¨èï¼‰

æ‰“åŒ…æ—¶å·²è‡ªåŠ¨åŒ…å« `ecosystem.config.js` é…ç½®æ–‡ä»¶ï¼Œç›´æ¥å¯åŠ¨å³å¯ï¼š
```bash
# æµ‹è¯•æœåŠ¡å™¨
pm2 start ecosystem.config.js --only gemini-staging

# æ­£å¼æœåŠ¡å™¨
pm2 start ecosystem.config.js --only gemini-prod

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs
```

## ğŸ”§ æœ¬åœ°æµ‹è¯•æ‰“åŒ…åçš„ä»£ç 

### æµ‹è¯•ç¯å¢ƒ
```bash
pnpm run build:staging
pnpm run start:staging
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
pnpm run build:prod
pnpm run start:prod
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡æ£€æŸ¥**
   - éƒ¨ç½²å‰è¯·æ£€æŸ¥ `.env.staging` å’Œ `.env.prod` ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®
   - ç‰¹åˆ«æ³¨æ„æ•°æ®åº“ã€Redis è¿æ¥ä¿¡æ¯

2. **æœåŠ¡è´¦å·æ–‡ä»¶**
   - `sa.json` åŒ…å«æ•æ„Ÿå‡­è¯ï¼Œç¡®ä¿æœåŠ¡å™¨æ–‡ä»¶æƒé™ï¼š`chmod 600 sa.json`
   - ä¸è¦å°† `sa.json` æäº¤åˆ° Git

3. **ä»£ç†è®¾ç½®**
   - æœåŠ¡å™¨ç¯å¢ƒé€šå¸¸è®¾ç½® `USE_PROXY=false`
   - å¼€å‘ç¯å¢ƒå¯ä»¥è®¾ç½® `USE_PROXY=true`

4. **ç«¯å£å†²çª**
   - ç¡®ä¿ `PORT` é…ç½®ä¸å†²çª
   - æµ‹è¯•å’Œç”Ÿäº§æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ä¸åŒç«¯å£

## ğŸ”„ æ›´æ–°éƒ¨ç½²æµç¨‹

1. æœ¬åœ°ä¿®æ”¹ä»£ç 
2. è¿è¡Œå¯¹åº”ç¯å¢ƒçš„æ‰“åŒ…å‘½ä»¤
3. ä¸Šä¼  `dist/` ç›®å½•åˆ°æœåŠ¡å™¨
4. æœåŠ¡å™¨ä¸Šé‡å¯åº”ç”¨ï¼š
   ```bash
   pm2 restart gemini-staging  # æˆ– gemini-prod
   ```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šstart.sh è„šæœ¬æ— æ³•æ‰§è¡Œ - "/bin/bash^M: è§£é‡Šå™¨é”™è¯¯"
**åŸå› ï¼š** Windows æ¢è¡Œç¬¦ï¼ˆCRLFï¼‰é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# è½¬æ¢æ¢è¡Œç¬¦ä¸º Linux æ ¼å¼
sed -i 's/\r$//' start.sh

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x start.sh

# å†æ¬¡å°è¯•æ‰§è¡Œ
./start.sh staging
```

**å¦‚æœæ²¡æœ‰ sed å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ dos2unixï¼š**
```bash
dos2unix start.sh
chmod +x start.sh
./start.sh staging
```

### é—®é¢˜ï¼šå¯åŠ¨å¤±è´¥ - "æœªçŸ¥çš„ NODE_ENV: undefined"
**åŸå› ï¼š** ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# âŒ é”™è¯¯æ–¹å¼ï¼ˆWindows å‘½ä»¤åœ¨ Linux ä¸Šä¸å·¥ä½œï¼‰
set NODE_ENV=staging && node src/main.js

# âœ… æ­£ç¡®æ–¹å¼ï¼ˆLinuxï¼‰
export NODE_ENV=staging
node src/main.js

# æˆ–ç›´æ¥åœ¨å‘½ä»¤å‰è®¾ç½®
NODE_ENV=staging node src/main.js

# âœ… æ¨èï¼šä½¿ç”¨ PM2 æˆ–å¯åŠ¨è„šæœ¬
pm2 start ecosystem.config.js --only gemini-staging
# æˆ–
./start.sh staging
```

### é—®é¢˜ï¼šä½¿ç”¨ pnpm start:staging æŠ¥é”™
**åŸå› ï¼š** æœåŠ¡å™¨ä¸Šå¯èƒ½ç¼ºå°‘æŸäº› dev ä¾èµ–

**è§£å†³æ–¹æ¡ˆï¼š** ä¸è¦ä½¿ç”¨ pnpm è„šæœ¬ï¼Œç›´æ¥ç”¨ä¸Šé¢çš„æ–¹å¼å¯åŠ¨

### é—®é¢˜ï¼šç¯å¢ƒå˜é‡éªŒè¯å¤±è´¥
- æ£€æŸ¥ `.env.staging` æˆ– `.env.prod` æ˜¯å¦å­˜åœ¨äº dist ç›®å½•
- ç¡®è®¤é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½æœ‰å€¼
- æŸ¥çœ‹æ—¥å¿—ï¼š`pm2 logs`

### é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
- æ£€æŸ¥ `DATABASE_URL` é…ç½®
- ç¡®è®¤æœåŠ¡å™¨èƒ½è®¿é—®æ•°æ®åº“

### é—®é¢˜ï¼šRedis è¿æ¥å¤±è´¥
- æ£€æŸ¥ `REDIS_URL`ã€`REDIS_PASSWORD`ã€`REDIS_PROT`
- ç¡®è®¤é˜²ç«å¢™è§„åˆ™

### é—®é¢˜ï¼šGCP è®¤è¯å¤±è´¥
- æ£€æŸ¥ `sa.json` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ `GCP_SERVICE_ACCOUNT_PATH` è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æœåŠ¡è´¦å·æƒé™
