openapi: 3.0.0
paths:
  /gemini/chat:
    post:
      description: 接收用户消息，返回 Gemini 模型生成的回复。
      operationId: ChatController_handleChat
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatMessageParamsDto"
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        type: string
                        description: Gemini结果
                        example: 你好！很高兴你来这里。有什么我可以帮忙的吗？
      summary: Gemini 聊天接口
      tags: &a1
        - Chat 聊天
  /gemini/stream:
    post:
      operationId: ChatController_handleChatStream
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatStreamRequestDto"
      responses:
        "200":
          description: ""
          content:
            text/event-stream:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        type: string
                        description: 流式响应内容
                        example: 你好！很高兴你来这里。有什么我可以帮忙的吗？
      summary: Gemini 流式聊天接口（SSE）
      tags: *a1
  /gemini/generate-voice:
    post:
      operationId: ChatController_handleGenerateVoice
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenerateVoiceRequestDto"
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        type: string
                        description: 语音文件地址
                        example: https://www.baidu.com
      summary: 生成语音接口
      tags: *a1
  /menu/menu-list:
    get:
      description: 返回菜单列表分页
      operationId: MenuController_findAll
      parameters: []
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/MenuItemDto"
                        description: 返回数据
      summary: 菜单列表
      tags:
        - 菜单
  /tts-task/create:
    post:
      description: 创建语音生成队列
      operationId: TtsTaskController_create
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTtsTaskDto"
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        $ref: "#/components/schemas/TaskExecuteDto"
                        description: 返回数据
      summary: 创建语音生成任务
      tags: &a2
        - 语音生成
  /tts-task/update:
    put:
      description: 创建更新语音任务
      operationId: TtsTaskController_updateTasks
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateTtsTasksDto"
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        $ref: "#/components/schemas/TaskExecuteDto"
                        description: 返回数据
      summary: 更新语音
      tags: *a2
  /tts-task/status:
    get:
      description: 根据ID查询任务状态
      operationId: TtsTaskController_status
      parameters:
        - name: schemeId
          required: true
          in: query
          description: 方案 ID
          schema:
            example: 1
            type: string
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/SegmentDto"
                        description: 返回数据
      summary: 查询任务状态
      tags: *a2
  /tts-task/overall-status:
    get:
      description: 根据ID查询任务聚合状态
      operationId: TtsTaskController_overallStatus
      parameters:
        - name: schemeId
          required: true
          in: query
          description: 方案 ID
          schema:
            example: "12345"
            type: string
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        $ref: "#/components/schemas/OverallResponseDto"
                        description: 返回数据
      summary: 查询任务聚合状态
      tags: *a2
  /tts-task/retry:
    post:
      description: 根据id和索引重试指定的任务
      operationId: TtsTaskController_retry
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RetryFailedIndexesDto"
      responses:
        "201":
          description: ""
      summary: 重试任务
      tags: *a2
  /upload/file:
    post:
      operationId: UploadController_uploadFile
      parameters: []
      requestBody:
        required: true
        description: 文件上传
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/UploadFileDto"
      responses:
        "200":
          description: ""
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ResponseDto"
                  - properties:
                      data:
                        $ref: "#/components/schemas/UploadFileResponseDto"
                        description: 返回数据
      summary: 上传单个文件到 OSS
      tags:
        - 文件上传
info:
  title: Gemini Api 接口文档
  description: 基于 NestJS 实现的聊天与语音生成 API 服务
  version: 1.0.0
  contact: {}
tags: []
servers:
  - url: /api
components:
  securitySchemes:
    bearer:
      scheme: bearer
      bearerFormat: JWT
      type: http
  schemas:
    ResponseDto:
      type: object
      properties:
        code:
          type: number
          example: 0
          description: 业务状态码，0 表示成功
        msg:
          type: string
          example: success
          description: 提示信息
        data:
          type: object
          description: 返回数据
      required:
        - code
        - msg
        - data
    ChatMessageParamsDto:
      type: object
      properties:
        message:
          type: string
          example: 你好世界
          description: 用户输入的消息文本
      required:
        - message
    ChatStreamRequestDto:
      type: object
      properties:
        message:
          type: string
          example: 你好世界
          description: 流式输出的消息文本
      required:
        - message
    GenerateVoiceRequestDto:
      type: object
      properties:
        text:
          type: string
          example: 你好世界
          description: 要转换为语音的文本
        voiceName:
          type: string
          example: Kore
          description: 音色名称
        outputFile:
          type: string
          example: out.wav
          description: 输出文件名
      required:
        - text
    MetaDto:
      type: object
      properties:
        title:
          type: string
          description: 页面标题
        icon:
          type: string
          description: 图标
          nullable: true
        noCache:
          type: boolean
          description: 是否缓存
          default: false
        breadcrumb:
          type: boolean
          description: 是否显示面包屑
          default: true
        affix:
          type: boolean
          description: 是否固定标签页
          default: false
        hidden:
          type: boolean
          description: 是否隐藏菜单
          default: false
        noTagsView:
          type: boolean
          description: 是否禁用标签页
          default: false
        activeMenu:
          type: string
          description: 激活菜单
          nullable: true
        canTo:
          type: boolean
          description: 是否可以跳转
          default: false
        permissionList:
          description: 权限列表
          default: []
          type: array
          items:
            type: string
      required:
        - title
        - noCache
        - breadcrumb
        - affix
        - hidden
        - noTagsView
        - canTo
        - permissionList
    MenuItemDto:
      type: object
      properties:
        id:
          type: number
          description: 菜单ID
        parentId:
          type: number
          description: 父菜单ID
        path:
          type: string
          description: 路由路径
        component:
          type: string
          description: 组件路径或标识
        redirect:
          type: string
          description: 重定向地址
          nullable: true
        name:
          type: string
          description: 路由名称
        meta:
          description: 路由元信息
          allOf:
            - $ref: "#/components/schemas/MetaDto"
        permission:
          description: 权限
          default: []
          type: array
          items:
            type: string
        children:
          description: 子菜单
          default: []
          type: array
          items:
            $ref: "#/components/schemas/MenuItemDto"
      required:
        - id
        - parentId
        - path
        - component
        - name
        - meta
        - permission
        - children
    TaskExecuteDto:
      type: object
      properties:
        totalTasks:
          type: number
          description: 执行任务的总数
        schemeId:
          type: number
          description: 当前执行的方案id
      required:
        - totalTasks
        - schemeId
    TranslationDto:
      type: object
      properties:
        begin:
          type: string
          description: 开头文本
          example: Hello
        middle:
          type: string
          description: 中间文本
          example: world
        end:
          type: string
          description: 结尾文本
          example: "!"
      required:
        - begin
        - middle
        - end
    ActualSchemeDto:
      type: object
      properties:
        translation:
          description: 翻译内容
          allOf:
            - $ref: "#/components/schemas/TranslationDto"
      required:
        - translation
    CreateTtsTaskDto:
      type: object
      properties:
        schemeId:
          type: number
          description: 方案 ID
          example: 1
        actualScheme:
          description: 实际方案数组
          example:
            - translation:
                begin: Hello
                middle: world
                end: "!"
            - translation:
                begin: Good
                middle: morning
                end: .
          type: array
          items:
            $ref: "#/components/schemas/ActualSchemeDto"
        voiceName:
          type: string
          description: 语音模型名称
          example: Kore
          default: Kore
        provider:
          type: string
          description: AI模型名称
          example: Gemini
      required:
        - schemeId
        - actualScheme
        - voiceName
        - provider
    UpdateTtsTaskItemDto:
      type: object
      properties:
        schemeIndex:
          type: number
          description: 方案中的片段索引（从0开始）
        segmentKey:
          type: string
          description: 片段 key
          enum:
            - begin
            - middle
            - end
        newText:
          type: string
          description: 新的翻译文案
      required:
        - schemeIndex
        - segmentKey
        - newText
    UpdateTtsTasksDto:
      type: object
      properties:
        schemeId:
          type: number
          description: 方案 ID
        updates:
          description: 要更新的任务列表
          type: array
          items:
            $ref: "#/components/schemas/UpdateTtsTaskItemDto"
      required:
        - schemeId
        - updates
    ChineseNarrationDto:
      type: object
      properties:
        begin:
          type: string
          description: begin 段中文内容
        middle:
          type: string
          description: middle 段中文内容
        end:
          type: string
          description: end 段中文内容
      required:
        - begin
        - middle
        - end
    UsedSegmentDto:
      type: object
      properties:
        segUid:
          type: string
          description: 使用的分段 UID，例如 "1+2+3"
        time:
          type: string
          description: 对应每段音频时间，例如 "18秒,17秒,9秒"
      required:
        - segUid
        - time
    SchemeContentDto:
      type: object
      properties:
        chineseNarration:
          description: 中文叙述内容
          allOf:
            - $ref: "#/components/schemas/ChineseNarrationDto"
        chineseWordCount:
          type: string
          description: 中文总字数
        combinationContent:
          type: string
          description: 组合内容描述
        combinationEmotion:
          type: string
          description: 组合情绪
        combinationLogic:
          type: string
          description: 组合逻辑描述
        planNumber:
          type: string
          description: 方案编号
        title:
          type: string
          description: 标题
        translation:
          description: 英文翻译
          allOf:
            - $ref: "#/components/schemas/TranslationDto"
        usedSegment:
          description: 已使用的分段信息
          allOf:
            - $ref: "#/components/schemas/UsedSegmentDto"
        videoDurationSeconds:
          type: string
          description: 视频总时长（秒）
      required:
        - chineseNarration
        - chineseWordCount
        - combinationContent
        - combinationEmotion
        - combinationLogic
        - planNumber
        - title
        - translation
        - usedSegment
        - videoDurationSeconds
    AudioUrlDto:
      type: object
      properties:
        beginAudioUrl:
          type: string
          description: begin 段音频 URL
        middleAudioUrl:
          type: string
          description: middle 段音频 URL
        endAudioUrl:
          type: string
          description: end 段音频 URL
      required:
        - beginAudioUrl
        - middleAudioUrl
        - endAudioUrl
    DownloadContentDto:
      type: object
      properties:
        planNumber:
          type: string
          description: 方案编号
        schemeContent:
          description: 方案内容
          allOf:
            - $ref: "#/components/schemas/SchemeContentDto"
        audioUrl:
          description: 音频 URL 对象
          allOf:
            - $ref: "#/components/schemas/AudioUrlDto"
      required:
        - planNumber
        - schemeContent
        - audioUrl
    SegmentDto:
      type: object
      properties:
        id:
          type: string
          description: 唯一 ID
        schemeId:
          type: string
          description: 方案 ID
        schemeIndex:
          type: number
          description: 方案索引
        segmentKey:
          type: string
          description: 分段 key，例如 begin/middle/end
        textContent:
          type: string
          description: 文本内容
        audioUrl:
          type: string
          description: 音频 URL
        status:
          type: number
          description: 状态，1 成功、0 待处理、2 失败
        retryCount:
          type: number
          description: 当前重试次数
        maxRetry:
          type: number
          description: 最大重试次数
        errorLog:
          type: string
          description: 错误日志
          nullable: true
        createTime:
          type: string
          description: 创建时间
        updateTime:
          type: string
          description: 更新时间
        voiceName:
          type: string
          description: 使用的声音名称
        downloadContent:
          description: 下载内容数组
          type: array
          items:
            $ref: "#/components/schemas/DownloadContentDto"
      required:
        - id
        - schemeId
        - schemeIndex
        - segmentKey
        - textContent
        - audioUrl
        - status
        - retryCount
        - maxRetry
        - errorLog
        - createTime
        - updateTime
        - voiceName
        - downloadContent
    StatsDto:
      type: object
      properties:
        success:
          type: number
          description: 成功数量
        failed:
          type: number
          description: 失败数量
        unfinished:
          type: number
          description: 未完成数量
        total:
          type: number
          description: 总数
      required:
        - success
        - failed
        - unfinished
        - total
    OverallResponseDto:
      type: object
      properties:
        overall:
          type: string
          description: 总体状态，例如 success/fail
        stats:
          description: 统计信息
          allOf:
            - $ref: "#/components/schemas/StatsDto"
      required:
        - overall
        - stats
    FailedIndexDto:
      type: object
      properties:
        schemeIndex:
          type: number
          description: 方案索引
          example: 0
        segmentKey:
          type: string
          description: 片段 key
          enum:
            - begin
            - middle
            - end
          example: begin
      required:
        - schemeIndex
        - segmentKey
    RetryFailedIndexesDto:
      type: object
      properties:
        schemeId:
          type: number
          description: 方案 ID
          example: 1
        failedIndexes:
          description: 失败的任务索引
          example:
            - schemeIndex: 0
              segmentKey: begin
            - schemeIndex: 1
              segmentKey: end
          type: array
          items:
            $ref: "#/components/schemas/FailedIndexDto"
        voiceName:
          type: string
          description: 语音模型名称
          example: Kore
          default: Kore
        provider:
          type: string
          description: AI模型名称
          example: Gemini
      required:
        - schemeId
        - failedIndexes
        - voiceName
        - provider
    UploadFileResponseDto:
      type: object
      properties:
        url:
          type: string
          example: https://your-bucket.oss-cn-shanghai.aliyuncs.com/uploads/1692612345678-test.png
          description: 文件访问 URL
        name:
          type: string
          example: uploads/1692612345678-test.png
          description: OSS 文件路径（key）
      required:
        - url
        - name
    UploadFileDto:
      type: object
      properties:
        file:
          type: string
          format: binary
          description: 待上传文件
      required:
        - file
